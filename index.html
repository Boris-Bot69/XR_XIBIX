<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>XIBIX Video in AR</title>
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>

    <style>
        .ar-button { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 12px 24px; border: none; background-color: #0078D4; color: white; border-radius: 8px; font-size: 16px; cursor: pointer; z-index: 100; }
    </style>
</head>
<body>

<script id="video-vertex-shader" type="x-shader/x-vertex">
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
</script>

<script id="video-fragment-shader" type="x-shader/x-fragment">
    varying vec2 vUv;
    uniform sampler2D src;
    uniform float radius;

    // Function to calculate the distance from a rounded rectangle shape
    float roundedRectangle(vec2 uv, vec2 size, float radius) {
      // Normalize coordinates to be centered at 0.0
      uv = uv - 0.5;
      size = size - radius;
      return length(max(abs(uv) - size, 0.0)) - radius;
    }

    void main() {
      // Get the video color at the current pixel
      vec4 videoColor = texture2D(src, vUv);

      // Calculate if the pixel is outside our shape
      float distance = roundedRectangle(vUv, vec2(0.5), radius);

      // If outside, discard the pixel (make it fully transparent)
      if (distance > 0.0) {
        discard;
      }

      // Otherwise, show the video pixel
      gl_FragColor = videoColor;
    }
</script>

<a-scene>
    <a-assets>
        <video id="sample-video" src="./robot_introduction.mp4" loop playsinline webkit-playsinline crossorigin="anonymous"></video>
    </a-assets>

    <a-video
            width="80"
            height="45"
            position="0 0 -75"
            material="
                shader: roundedVideo;
                src: #sample-video;
                radius: 0.1;
                transparent: true;
            ">
    </a-video>
</a-scene>

<div id="overlay">
    <button class="ar-button" onclick="document.querySelector('a-scene').enterVR(true)">Enter AR and rotate your phone left</button>
</div>

<script>
    AFRAME.registerShader('roundedVideo', {
        schema: {
            src: {type: 'map', is: 'uniform'},
            radius: {type: 'number', is: 'uniform', default: 0.1}
        },
        vertexShader: document.getElementById('video-vertex-shader').textContent,
        fragmentShader: document.getElementById('video-fragment-shader').textContent
    });

    // Function to start the video on user interaction
    function playVideo() {
        var video = document.querySelector('#sample-video');
        if (video.paused) {
            video.play().catch(e => console.error("Video play failed:", e));
        }
    }
    window.addEventListener('click', playVideo, { once: true });
</script>

</body>
</html>
